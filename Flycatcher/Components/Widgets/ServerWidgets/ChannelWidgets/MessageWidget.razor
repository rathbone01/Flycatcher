@using Flycatcher.Components
@inject IDialogService DialogService

@if (Message.Content is null)
    return;

<MudPaper Elevation="3" Class="message-widget">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="flex: 1;">
            <MudText Style="margin-left: 10px;" Typo="Typo.body1">@Message.User.Username</MudText>
            <MudText Style="margin-left: 10px; font-size: 0.75rem; color: var(--mud-palette-text-secondary);" Typo="Typo.caption">
                @Message.Timestamp.ToString("MMM d, yyyy h:mm tt") UTC
            </MudText>
        </div>
        @if (CanShowDeleteButton())
        {
            <div class="delete-button-container" style="margin-right: 10px;">
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Size="Size.Small"
                               Color="Color.Error"
                               OnClick="HandleDeleteClick" />
            </div>
        }
    </div>

    @if (Message.IsDeleted)
    {
        <MudText Style="margin-left: 10px; margin-bottom: 10px; font-style: italic; opacity: 0.6;"
                 Typo="Typo.body2"
                 Color="Color.Default">
            [Message deleted]
        </MudText>
    }
    else
    {
        <MudText Style="margin-left: 10px; margin-bottom: 10px; width: 98%; white-space: pre-wrap; word-wrap: break-word;" Typo="Typo.body2">
            @Message.Content.Replace("\r\n", "\n").Replace("\r", "\n")
        </MudText>
    }
</MudPaper>

<style>
    .message-widget:hover .delete-button-container {
        opacity: 1;
    }

    .delete-button-container {
        opacity: 0;
        transition: opacity 0.2s;
    }
</style>

@code {
    [Parameter]
    public required Message Message { get; set; }

    [Parameter]
    public int LoggedInUserId { get; set; }

    [Parameter]
    public bool CanDeleteOthersMessages { get; set; } = false;

    [Parameter]
    public EventCallback<int> OnDeleteRequested { get; set; }

    private bool CanShowDeleteButton()
    {
        if (Message.IsDeleted)
            return false;

        return Message.UserId == LoggedInUserId || CanDeleteOthersMessages;
    }

    private async Task HandleDeleteClick()
    {
        var parameters = new DialogParameters
        {
            { "Title", "Delete Message" },
            { "Message", "Are you sure you want to delete this message? This action cannot be undone." },
            { "ItemName", "" }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = await DialogService.ShowAsync<DeleteDialog>("Delete Message", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await OnDeleteRequested.InvokeAsync(Message.Id);
        }
    }
}
